@model Encadenamiento.WebApp.Models.ViewModels.VMPDFVisita;
@{
    Layout = null;
}

<!DOCTYPE html>

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitas de Campo</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            color: #333;
            padding: 5px;
        }

        .container {
            padding: 10px;
            border-radius: 1px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        h1 {
            text-align: center;
            color: darkgreen;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .info {
            background-color: #e6f4e6;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .info td {
            padding: 8px;
            border-bottom: 1px solid #ccc;
        }

        .image {
            text-align: center;
            margin-bottom: 10px;
        }

        .image img {
            width: 45%;
            height: auto;
            margin: 10px;
            border: 1px solid #ddd;
        }

        .observations, .activities {
            margin-bottom: 20px;
        }

        .signature {
            margin-top: 30px;
        }

        .signature p {
            font-style: italic;
        }

        .header {
            text-align: center;
            position: relative;
            padding-top: 15px;
        }

        .header img {
            width: 180px;
            height: auto;
        }

        .container::before,
        .container::after {
            content: "";
            display: block;
            width: 100%;
            height: 10px;
            background-color: #F36F22;
            position: absolute;
            left: 0;
        }

        .container::before {
            top: 0;
        }

        .container::after {
            bottom: 0;
        }

        .franja-derecha {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 33%;
            background-color: #F36F22;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #e6f4e6;
            font-size: 16px;
            font-weight: bold;
        }

        .ambito-header {
            text-align: center !important;
            background-color: lightgray;
            font-weight: bold;
            font-size: 18px;
            padding: 10px;
        }

        .image-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .image-container .image img {
            width: auto; /* El ancho se ajustará automáticamente */
            max-width: 47%; /* Limita el ancho de cada imagen */
            max-height: 300px; /* Altura máxima fija para ambas imágenes */
            display: inline-block;
            margin: 1%;
            object-fit: cover; /* Recorta la imagen para mantener la misma altura */
            border: 1px solid #ddd; /* Borde opcional */
        }

    </style>

</head>
<body>

    <div class="container">
        <div class="header">
            <img src="@Model.negocio.UrlLogo" alt="Logo img">
        </div>
        <h1>INFORME DE VISITA</h1>
        
        <table class="info" style="width: 100%;">
            <tr>
                <td><strong>Proveedor: </strong> @Model.visita.Proveedor</td>
            </tr>
            <tr>
                <td><strong>Finca: </strong> @Model.visita.NombreFinca</td>
            </tr>
            <tr>
                <td><strong>Fecha: </strong> @(DateTime.Now.ToString("dd/MM/yyyy") ?? "n/d")</td>
            </tr>
        </table>

        @{
            var fechaMasReciente = Model.visita.DetalleVisita
                .Where(a => a.FechaUltimarevision.HasValue)
                .OrderByDescending(a => a.FechaUltimarevision)
                .FirstOrDefault()?.FechaUltimarevision;
        }

        <p>
            Estimado proveedor de caña, como parte del proyecto de encadenamiento de productores de caña de azúcar, que
            Pantaleon lleva a cabo para apoyarles en el cumplimiento de normas y regulaciones que la legislación nacional
            indica, le compartimos el informde de visita que hemos elaborado para reducir las brechas de cumplimiento de requisitos,
            identificadas en las últimas evaluaciones realizadas en su finca.
            <br />
            <br />
            La visita fue realizada para abordar tareas del plan e trabajo actual y registrando como responsable a la persona que atendió 
            la visita junto con el mandador o capataz que acompañó, tomar en cuenta que la última fecha de actualización de este plan corresponde a:
            @(fechaMasReciente?.ToString("dd/MM/yyyy") ?? "(aun no se actualiza)").            
        </p>
        
        <p>La visita se realiza para revisar avances del plan de trabajo para su finca correspondiente a la zafra <strong>@((Model.visita.Zafra ?? 0).ToString("F2")) %</strong>
            luego de actualizar las tareas y actividades que corresponden adicho plan.
        </p>
        <br />

        <div class="observations">
            <table class="table" style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td colspan="2" style="padding: 5px; font-weight: bold;">Número de Visita:</td>
                    <td colspan="1" style="padding: 5px;">@Model.visita.IdVisita</td>
                    <td colspan="2" style="padding: 5px; font-weight: bold;">Descripción:</td>
                    <td colspan="7" style="padding: 5px; word-wrap: break-word;">@Model.visita.IdPlan.ToString() @Model.visita.DescripcionPlan</td>
                </tr>
                <tr>
                    <td colspan="2" style="padding: 5px; font-weight: bold;">Fecha :</td>
                    <td colspan="1" style="padding: 5px;">@Model.visita.Fecha?.ToString("dd/MM/yyyy")</td>
                    <td colspan="2" style="padding: 5px; font-weight: bold;">Responsable:</td>
                    <td colspan="2" style="padding: 5px;">@Model.visita.Responsable</td>
                    <td colspan="2" style="padding: 5px; font-weight: bold;">Mandador:</td>
                    <td colspan="2" style="padding: 5px;">@Model.visita.Mandador</td>
                </tr>
                <tr>
                    <td colspan="2" style="padding: 5px; font-weight: bold;">Observación:</td>
                    <td colspan="10" style="padding: 5px; word-wrap: break-word;">@Model.visita.Observaciones</td>
                </tr>
            </table>
        </div>


        <div class="activities">
            <p><span class="section-title">Resultados obtenidos:</span></p>

            @if (Model.visita.DetalleVisita != null && Model.visita.DetalleVisita.Any())
            {
                <table>
                    <thead>
                        <tr>
                            <th>IdRreg</th>
                            <th>Descripción</th>
                            <th>Tipo</th>
                            <th>Fecha</th>
                            <th>Avance Ant</th>
                            <th>Avance</th>
                            <th>Estado Ant</th>
                            <th>Estado</th>                            
                            <th>Comentarios</th>
                            <th>Observaciones</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var det in Model.visita.DetalleVisita)
                        {
                            <tr>
                                <td>@det.IdReg</td>
                                <td>@det.DescripcionActividad</td>
                                <td>@det.Tipo</td>
                                <td>@det.Fecha?.ToString("dd/MM/yyyy")</td>
                                <td>@det.Avanceanterior?.ToString("F2")</td>
                                <td>@det.Avances?.ToString("F2")</td>
                                <td>@det.Estadoanterior</td>
                                <td>@det.Estado</td>
                                <td>@det.Comentarios</td>                                
                                <td>@det.Observaciones</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p>No se encontraron actividades.</p>
            }
        </div>

        <div class="image-container">
            <div class="image">
                <img src="@Model.visita.UrlFoto1" alt="Foto 1">
                <img src="@Model.visita.UrlFoto2" alt="Foto 2">                
            </div>
            <div class="image">                                
                <img src="@Model.visita.UrlFoto3" alt="Foto 3">
                <img src="@Model.visita.UrlFoto4" alt="Foto 4">
            </div>
            @if (!string.IsNullOrEmpty(Model.visita.MapaBase64))
            {
                <div style="margin: 20px 0; text-align: center; page-break-inside: avoid;">
                    <h4 style="color:#004DAF; margin-bottom: 10px;">Ubicación de la Visita</h4>
                    <img src="data:image/png;base64,@Model.visita.MapaBase64"
                         style="width: 100%; max-width: 600px; border: 1px solid #ddd; border-radius: 4px;"
                         alt="Mapa de ubicación" />
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Coordenadas: Lat @Model.visita.Latitud, Long @Model.visita.Longitud
                    </p>
                </div>
            }
            else if (!string.IsNullOrEmpty(Model.visita.Latitud) && !string.IsNullOrEmpty(Model.visita.Longitud))
            {
                <div style="margin: 20px 0; color: #ff0000; font-style: italic;">
                    No se pudo generar el mapa de ubicación (coordenadas disponibles: @Model.visita.Latitud, @Model.visita.Longitud)
                </div>
            }
        </div>

        <div class="signature">
            <p>Quedamos atentos a sus comentarios u observaciones al respecto.</p>
            <p>Saludos,</p>
            <p>Unidad de Negocios de Caña</p>
        </div>
      
    </div> 
</body>
</html>
